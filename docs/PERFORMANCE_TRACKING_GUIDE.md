# RAG系统性能追踪功能使用指南

## 🎯 功能概述

RAG系统现已集成完整的性能追踪功能，可以实时监控和分析系统各个阶段的执行时间，帮助用户了解系统性能并进行优化。

## 📊 主要功能

### 1. ⏱️ 实时响应时间显示
- **位置**: 智能问答页面
- **功能**: 每次查询后自动显示回答时间
- **格式**: 毫秒(ms) 或 秒(s)
- **示例**: `⏱️ 回答时间: 1.23s`

### 2. 📈 详细性能统计
- **位置**: 智能问答页面 > 详细性能统计（可展开）
- **内容**:
  - 总执行时间
  - 执行阶段数
  - 平均阶段时间
  - 各阶段耗时详情和百分比

### 3. 📊 RAG性能统计页面
- **访问方式**: 侧边栏 > ⏱️ RAG 性能统计
- **包含内容**:
  - 当前会话性能摘要
  - 各阶段耗时分布图表
  - 历史查询性能统计
  - 响应时间趋势分析
  - 性能优化建议
  - 数据导出功能

## 🔧 追踪的执行阶段

系统会自动追踪以下关键阶段的执行时间：

### 📤 文档索引阶段
1. **总索引时间** - 完整的文档索引过程
2. **文档解析** - 解析上传的文档内容
3. **文本分块** - 将文档分割成可处理的块
4. **嵌入向量生成** - 生成文档的向量表示
5. **索引创建** - 在Elasticsearch中创建索引

### 🔍 查询处理阶段
1. **总查询时间** - 完整的查询响应过程
2. **查询处理** - 处理用户查询
3. **相似性搜索** - 在向量空间中搜索相似内容
4. **上下文检索** - 提取相关的上下文信息
5. **LLM推理** - 大语言模型生成回答

## 📱 使用方法

### 基本查询时间查看
1. 进入 **💬 智能问答** 页面
2. 提交任何问题
3. 查看回答下方显示的 `⏱️ 回答时间`

### 详细性能分析
1. 在智能问答页面查询后
2. 点击 **📊 详细性能统计** 展开面板
3. 查看各阶段的具体耗时和占比

### 性能趋势分析
1. 点击侧边栏的 **⏱️ RAG 性能统计**
2. 查看以下内容：
   - **📈 当前会话性能摘要**: 当前会话的综合性能指标
   - **📊 各阶段耗时分布**: 饼图和条形图显示时间分布
   - **📚 历史查询性能统计**: 所有查询的统计分析
   - **📈 响应时间趋势**: 查询响应时间的变化趋势

### 数据导出
1. 在RAG性能统计页面底部
2. 选择导出格式：
   - **📋 导出性能数据 (JSON)**: 结构化数据格式
   - **📊 导出性能数据 (CSV)**: 表格数据格式
3. 下载文件进行进一步分析

## 💡 性能优化建议

系统会根据实际性能数据提供智能优化建议：

### 🎯 常见性能瓶颈及解决方案

1. **查询处理耗时较长**
   - 考虑优化检索策略
   - 调整相似性搜索参数
   - 检查Elasticsearch配置

2. **嵌入生成耗时较长**
   - 考虑使用更快的嵌入模型
   - 检查Jina API连接状态
   - 启用本地缓存

3. **索引创建耗时较长**
   - 考虑批量处理文档
   - 增加系统资源配置
   - 优化文档预处理流程

## 📊 性能指标解读

### 时间单位
- **毫秒 (ms)**: 0-999毫秒显示为 "XXXms"
- **秒 (s)**: 1秒以上显示为 "X.XXs"
- **分钟 (m)**: 60秒以上显示为 "XmX.Xs"

### 性能等级参考
- **优秀**: 查询响应 < 2秒
- **良好**: 查询响应 2-5秒
- **需要优化**: 查询响应 > 5秒

### 阶段占比分析
- **相似性搜索**: 通常占总时间的30-50%
- **LLM推理**: 通常占总时间的40-60%
- **其他阶段**: 通常占总时间的10-20%

## 🔧 技术细节

### 追踪实现
- 使用上下文管理器自动追踪执行时间
- 支持嵌套阶段追踪
- 线程安全的全局追踪器

### 数据存储
- 会话级别的性能数据存储
- 自动清理和重置机制
- 支持数据导出和备份

### 可视化支持
- 优先使用Plotly进行高级可视化
- 回退到Streamlit内建图表（如无Plotly）
- 响应式图表设计

## ❓ 常见问题

### Q: 为什么性能数据为空？
A: 需要先执行一些查询操作来生成性能数据。

### Q: 如何重置性能数据？
A: 在RAG性能统计页面点击"🗑️ 清空当前会话性能数据"按钮。

### Q: 图表显示异常？
A: 可能缺少Plotly依赖，系统会自动使用简化图表显示。

### Q: 导出的数据如何使用？
A: JSON格式适合程序处理，CSV格式适合Excel等工具分析。

## 🎉 总结

RAG系统的性能追踪功能为用户提供了：
- **透明度**: 清楚了解每个操作的耗时
- **可视化**: 丰富的图表和统计展示
- **可操作性**: 基于数据的具体优化建议
- **历史追踪**: 完整的性能历史记录

这些功能帮助用户更好地理解和优化RAG系统的性能表现。